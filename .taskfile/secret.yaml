---
version: "3"

vars:
  SECRET_PATHS_REGEX:
    sh: yq e '.creation_rules[].path_regex' .sops.yaml |  awk '{print "./"$0}' | tr '\n' '|'
  SECRET_FILES:
    sh: |
      {{ if eq OS "linux" }} find \
      {{ else if eq OS "darwin"}} gfind \
      {{ end }} -type f -regextype posix-egrep -regex "{{.SECRET_PATHS_REGEX}}"

tasks:
  ls:
    desc: List all secrets
    silent: true
    cmds:
      - echo "{{.SECRET_FILES}}"
  dec:
    desc: Decrypt all secrets
    silent: true
    cmds:
      - echo "{{.SECRET_FILES}}" | xargs  -I {} sops -d --ignore-mac -i {}
  enc:
    desc: Encrypt all secrets
    silent: true
    cmds:
      - echo "{{.SECRET_FILES}}" | xargs  -I {} sops -e -i {}
