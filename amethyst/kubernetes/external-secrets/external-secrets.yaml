---
# Helm
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: HelmRepository
metadata:
  namespace: external-secrets
  name: external-secrets
spec:
  url: https://charts.external-secrets.io
  interval: 24h
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  namespace: external-secrets
  name: external-secrets
spec:
  chart:
    spec:
      sourceRef:
        kind: HelmRepository
        name: external-secrets
      # renovate: registryUrl=https://charts.external-secrets.io
      chart: external-secrets
      version: 0.9.11
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  interval: 1h
  maxHistory: 1
  values:
    installCRDs: true

    # -- controller
    replicaCount: 1
    processClusterExternalSecret: false
    processClusterStore: false
    securityContext: &securityContext
      runAsNonRoot: true
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: RuntimeDefault
    resources: &resources
      limits:
        memory: 128Mi
      requests:
        cpu: 10m
        memory: 64Mi

    # -- certController
    certController:
      create: true
      replicaCount: 1
      resources: *resources
      securityContext: *securityContext

    # -- webhook
    webhook:
      create: true
      replicaCount: 1
      resources: *resources
      securityContext: *securityContext
