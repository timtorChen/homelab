---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  namespace: default
  name: qbittorrent
spec:
  chart:
    spec:
      sourceRef:
        kind: HelmRepository
        namespace: flux-system
        name: k8s-at-home
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: qbittorrent
      version: 13.2.0
  interval: 1h
  values:
    env:
      # UI port
      QBT_Preferences__WebUI__Port: 8080
      # peering port
      QBT_Preferences__Connection__PortRangeMin: 55230
      # bind connection on wireguard interface
      QBT_Preferences__Connection__Interface: wg-mullvad
      QBT_Preferences__General__Locale: zh_TW
      QBT_Preferences__Bittorrent__Encryption: 1
    envFrom:
      - secretRef:
          name: qbittorrent-secret

    ingress:
      main:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: nginx
          nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8, 192.168.0.0/16"
        hosts:
          - host: qb.${ROOT_DOMAIN}
            paths:
              - path: /

    service:
      main:
        ports:
          http:
            port: 8080
      tcp:
        enabled: true
        type: ClusterIP
        ports:
          tcp:
            enabled: true
            port: 55320
            protocol: TCP
            targetPort: 55320
      utp:
        enabled: true
        type: ClusterIP
        ports:
          utp:
            enabled: true
            port: 55320
            protocol: UDP
            targetPort: 55320

    persistence:
      config:
        enabled: true
        existingClaim: qbittorrent-config
        mountPath: /config
      downloads:
        enabled: true
        existingClaim: qbittorrent-download
        mountPath: /config/downloads
      wireguard:
        enabled: true
        type: secret
        name: qbittorrent-wireguard-secret
        mountPath: /etc/wireguard

    additionalContainers:
      # torrent over wireguard
      wireguard:
        name: wireguard
        image: k8sathome/wireguard:1.0.20200827
        volumeMounts:
          - name: wireguard
            mountPath: /etc/wireguard
        securityContext:
          runAsUser: 568
          runAsGroup: 568
          capabilities:
            add:
              - NET_ADMIN
              - SYS_MODULE
        env:
          - name: KILLSWITCH
            value: "true"

    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 300m
        memory: 512Mi
