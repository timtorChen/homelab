---
apiVersion: kubegres.reactive-tech.io/v1
kind: Kubegres
metadata:
  namespace: default
  name: nextcloud-kubegres

spec:
  replicas: 3
  image: postgres:13.7
  port: 5432

  database:
    size: 1Gi
    storageClassName: proxmox-nvme

  failover:
    isDisabled: false  # true to mantaince mode

  env:
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: nextcloud-kubegres-secret
          key: superUserPassword

    - name: POSTGRES_REPLICATION_PASSWORD
      valueFrom:
        secretKeyRef:
          name: nextcloud-kubegres-secret
          key: replicationUserPassword

  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 200m
      memory: 512Mi

  scheduler:
    affinity:
      nodeAffinity:
        # prefer in amd64 node
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            preference:
              matchExpressions:
                - key: kubernetes.io/arch
                  operator: In
                  values:
                    - amd64

      podAntiAffinity:
        # do not put kubegres pod in the same node
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - nextcloud-kubegres
            topologyKey: kubernetes.io/hostname
