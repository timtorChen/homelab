---
apiVersion: redis.redis.opstreelabs.in/v1beta1
kind: RedisCluster
metadata:
  namespace: default
  name: nextcloud-redis
spec:
  clusterSize: 3
  # TODO:
  # change to ot-container official image after supporting muliarch
  # the operator will crash without redisExporter/redisExporter.image items
  kubernetesConfig:
    image: timtor/redis:v6.2.5

    resources:
      limits:
        cpu: 300m
        memory: 300Mi
      requests:
        cpu: 100m
        memory: 128Mi

    redisSecret:
      name: nextcloud-redis-secret
      key: password

  redisLeader:
    affinity:
      podAntiAffinity:
        # do not put a leader in the same host
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - nextcloud-redis-leader
            topologyKey: kubernetes.io/hostname

  redisFollower:
    affinity:
      podAntiAffinity:
        # do not put a follower in the same host
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - nextcloud-redis-follower
            topologyKey: kubernetes.io/hostname

  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: proxmox-nvme
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi

  redisExporter:
    enabled: false
    image: quay.io/opstree/redis-exporter:1.0
